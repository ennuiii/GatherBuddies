---
phase: 1.5-integration
plan: 03
type: execute
---

<objective>
Integrate Phaser3 2D world into Hub GamePage.

Purpose: Add the virtual world experience to the template-based client.
Output: GamePage renders Phaser canvas with avatar movement connected to Colyseus.
</objective>

<context>
@.planning/PROJECT.md
@GameBuddiesHub/client/src/pages/GamePage.tsx (template version)
@GameBuddiesHub/client/src/scenes/Game.ts (Phase 1 Phaser code)
@GameBuddiesHub/client/src/characters/MyPlayer.ts (Phase 1)

**What we're doing:**
- Replace GamePlaceholder with Phaser canvas
- Migrate scenes/characters from Phase 1 implementation
- Connect Phaser to Colyseus for multiplayer state
- Use template's GamePage layout (game area + sidebar)

**What we keep from template:**
- GamePage layout (header, sidebar, drawer)
- Video chat integration
- Chat window in sidebar
- Player list in sidebar
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Phaser assets</name>
  <files>
    GameBuddiesHub/client/public/assets/
  </files>
  <action>
Copy assets from Phase 1 implementation (if not already present):

From GameBuddiesHub/client/public/assets/ (Phase 1) or SkyOffice:
- tilemap.json (map data)
- tileset images (FloorAndGround.png, etc.)
- character sprites (adam.png, etc.)

Ensure directory structure:
```
public/
  assets/
    tilemap/
      tilemap.json
    tilesets/
      FloorAndGround.png
      ...
    characters/
      adam.png
      ...
```

Add attribution for LimeZu assets if not present.
  </action>
  <verify>
Assets present in public/assets/.
Tilemap and character sprites available.
  </verify>
  <done>
Phaser assets in place for loading.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Phaser scenes</name>
  <files>
    GameBuddiesHub/client/src/game/scenes/Bootstrap.ts,
    GameBuddiesHub/client/src/game/scenes/Game.ts
  </files>
  <action>
Copy and adapt scenes from Phase 1 implementation:

1. Create src/game/ directory for Phaser code
2. Copy Bootstrap.ts scene (asset loading)
3. Copy Game.ts scene with modifications:
   - Remove direct Colyseus connection (moved to service)
   - Accept network service via scene data
   - Keep tilemap creation, player management
   - Keep collision detection
4. Update imports for new paths

Keep scenes focused on rendering/input, let services handle networking.
  </action>
  <verify>
Scenes compile without errors.
Bootstrap loads assets.
Game creates tilemap.
  </verify>
  <done>
Phaser scenes migrated to game/ directory.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate character classes</name>
  <files>
    GameBuddiesHub/client/src/game/characters/Player.ts,
    GameBuddiesHub/client/src/game/characters/MyPlayer.ts,
    GameBuddiesHub/client/src/game/characters/OtherPlayer.ts
  </files>
  <action>
Copy and adapt character classes from Phase 1:

1. Create src/game/characters/ directory
2. Copy Player.ts (base class with name label, dialog)
3. Copy MyPlayer.ts (keyboard input, sends updates)
4. Copy OtherPlayer.ts (interpolation for remote players)
5. Copy CharacterAnims.ts to src/game/anims/
6. Update imports

Modification: MyPlayer should emit events instead of calling network directly.
Use Phaser's event system or a callback pattern.

```typescript
// MyPlayer sends movement via callback
this.onMovementUpdate?.({
  x: this.x,
  y: this.y,
  anim: this.currentAnim,
});
```
  </action>
  <verify>
Character classes compile.
Animations defined correctly.
MyPlayer captures keyboard input.
  </verify>
  <done>
Character classes migrated with clean event pattern.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create PhaserGame React component</name>
  <files>
    GameBuddiesHub/client/src/components/game/PhaserGame.tsx
  </files>
  <action>
Create React component that wraps Phaser game:

```typescript
import { useEffect, useRef } from 'react';
import Phaser from 'phaser';
import { Bootstrap, Game } from '../../game/scenes';
import { colyseusService } from '../../services/colyseusService';

interface PhaserGameProps {
  roomCode: string;
  playerName: string;
  onReady?: () => void;
}

export function PhaserGame({ roomCode, playerName, onReady }: PhaserGameProps) {
  const gameRef = useRef<Phaser.Game | null>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!containerRef.current || gameRef.current) return;

    // Connect to Colyseus first
    colyseusService.joinHub(roomCode, playerName).then((room) => {
      // Create Phaser game with Colyseus room
      const config: Phaser.Types.Core.GameConfig = {
        type: Phaser.AUTO,
        parent: containerRef.current!,
        width: 800,
        height: 600,
        physics: { default: 'arcade' },
        scene: [Bootstrap, Game],
        scale: {
          mode: Phaser.Scale.RESIZE,
          autoCenter: Phaser.Scale.CENTER_BOTH,
        },
      };

      gameRef.current = new Phaser.Game(config);
      gameRef.current.registry.set('colyseusRoom', room);
      onReady?.();
    });

    return () => {
      colyseusService.leave();
      gameRef.current?.destroy(true);
      gameRef.current = null;
    };
  }, [roomCode, playerName, onReady]);

  return <div ref={containerRef} className="phaser-game-container" />;
}
```

This connects Colyseus when mounting and passes room to Phaser.
  </action>
  <verify>
Component renders container div.
Connects to Colyseus on mount.
Creates Phaser game instance.
  </verify>
  <done>
PhaserGame React component bridges React and Phaser.
  </done>
</task>

<task type="auto">
  <name>Task 5: Replace GamePlaceholder with PhaserGame</name>
  <files>
    GameBuddiesHub/client/src/pages/GamePage.tsx
  </files>
  <action>
Update GamePage to render Phaser instead of placeholder:

1. Import PhaserGame component
2. Get roomCode and playerName from lobby prop
3. Replace <GamePlaceholder /> with <PhaserGame />
4. Add CSS for phaser-game-container (full height of main-scroll-area)

```typescript
// In GamePage render:
<div className="main-scroll-area">
  <PhaserGame
    roomCode={lobby.code}
    playerName={lobby.players.find(p => p.socketId === lobby.mySocketId)?.name || 'Player'}
  />
</div>
```

Keep sidebar with chat/players (template functionality).
  </action>
  <verify>
GamePage renders Phaser canvas.
Sidebar still shows chat/players.
Responsive layout works.
  </verify>
  <done>
GamePage shows Phaser 2D world alongside template UI.
  </done>
</task>

<task type="auto">
  <name>Task 6: Connect Game scene to Colyseus state</name>
  <files>
    GameBuddiesHub/client/src/game/scenes/Game.ts
  </files>
  <action>
Update Game scene to sync with Colyseus:

1. Get Colyseus room from registry in create()
2. Listen to room.state.players.onAdd → create OtherPlayer
3. Listen to room.state.players.onRemove → destroy OtherPlayer
4. Listen to player.onChange → update OtherPlayer position
5. Send MyPlayer movements to room via room.send()

```typescript
// In Game.ts create():
const room = this.registry.get('colyseusRoom');

room.state.players.onAdd((player, sessionId) => {
  if (sessionId === room.sessionId) {
    // Create MyPlayer at spawn point
    this.myPlayer = new MyPlayer(this, spawnX, spawnY);
    this.myPlayer.onMovementUpdate = (data) => {
      room.send('UPDATE_PLAYER', data);
    };
  } else {
    // Create OtherPlayer
    const otherPlayer = new OtherPlayer(this, player.x, player.y, player.name);
    this.otherPlayers.set(sessionId, otherPlayer);

    player.onChange(() => {
      otherPlayer.setTargetPosition(player.x, player.y, player.anim);
    });
  }
});

room.state.players.onRemove((player, sessionId) => {
  this.otherPlayers.get(sessionId)?.destroy();
  this.otherPlayers.delete(sessionId);
});
```
  </action>
  <verify>
MyPlayer appears at spawn.
Other players appear when they join.
Movement syncs across clients.
  </verify>
  <done>
Phaser synced with Colyseus state.
Multiplayer avatar movement working.
  </done>
</task>

<task type="auto">
  <name>Task 7: End-to-end test</name>
  <files>
    (no changes - testing only)
  </files>
  <action>
Full integration test:

1. Start GameBuddieGamesServer (both Socket.IO and Colyseus)
2. Start Hub client
3. Open two browser tabs
4. Tab 1: Create room
5. Tab 1: Start game (enter hub)
6. Tab 2: Join same room
7. Tab 2: Start game (enter hub)
8. Verify both avatars visible
9. Move Tab 1 player → Tab 2 sees movement
10. Move Tab 2 player → Tab 1 sees movement
11. Verify sidebar chat works
12. Verify video controls work

Document any issues found.
  </action>
  <verify>
Both clients see each other's avatars.
Movement syncs in real-time.
Template features (chat, video) still work.
  </verify>
  <done>
Phase 1.5 integration complete.
Hub runs with both Socket.IO and Colyseus.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Phaser renders in GamePage
- [ ] Colyseus connection established when entering game
- [ ] MyPlayer controlled with WASD/arrows
- [ ] OtherPlayers appear and sync positions
- [ ] Template sidebar (chat, players) still works
- [ ] Video chat controls functional
</verification>

<success_criteria>
- Virtual 2D world renders in GamePage
- Multiplayer avatar movement works
- Integration with template UI complete
- Clean code separation (Phaser in game/, React in components/)
</success_criteria>

<output>
After completion, create `.planning/phases/1.5-integration/1.5-03-SUMMARY.md`
</output>
