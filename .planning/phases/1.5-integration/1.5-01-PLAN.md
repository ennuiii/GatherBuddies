---
phase: 1.5-integration
plan: 01
type: execute
---

<objective>
Add Colyseus server to GameBuddieGamesServer alongside Socket.IO.

Purpose: Enable 2D world state sync for the Hub while keeping Socket.IO for other games.
Output: Colyseus running on port 3002, HubRoom available for clients.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@GameBuddieGamesServer/core/server.ts
@GameBuddiesHub/server/rooms/HubRoom.ts
@GameBuddiesHub/server/rooms/schema/HubState.ts

**Research findings:**
- Colyseus and Socket.IO cannot share same port (WebSocket upgrade conflicts)
- Proven pattern: Socket.IO on 3001, Colyseus on 3002 (from RetroArcade)
- Colyseus attaches via WebSocketTransport with separate httpServer

**Key decisions:**
- Colyseus runs on port 3002 (env: COLYSEUS_PORT)
- HubRoom handles player positions, animations, chat
- Reuse schema from GameBuddiesHub/server
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Colyseus dependencies to GameBuddieGamesServer</name>
  <files>
    GameBuddieGamesServer/package.json
  </files>
  <action>
Add Colyseus dependencies:
- colyseus (^0.15)
- @colyseus/ws-transport
- @colyseus/monitor (optional, for debugging)

Run npm install after updating package.json.
  </action>
  <verify>
npm install completes without errors.
package.json shows colyseus dependencies.
  </verify>
  <done>
Colyseus packages installed in GameBuddieGamesServer.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ColyseusServer wrapper class</name>
  <files>
    GameBuddieGamesServer/core/colyseus/ColyseusServer.ts
  </files>
  <action>
Create ColyseusServer class that:
- Creates separate Express app and httpServer for Colyseus
- Initializes Colyseus Server with WebSocketTransport
- Provides methods: listen(port), shutdown(), define(roomName, roomClass)
- Configures CORS for same origins as main server
- Exports singleton instance

Reference: RetroArcade implementation pattern.

```typescript
// Structure:
export class ColyseusServer {
  private gameServer: Server;
  private colyseusApp: Express;
  private colyseusHttpServer: HTTPServer;

  constructor(corsOrigins: string[]);
  define(name: string, room: typeof Room): void;
  async listen(port: number): Promise<void>;
  async shutdown(): Promise<void>;
  getServer(): Server;
}
```
  </action>
  <verify>
File compiles without TypeScript errors.
Class structure matches specification.
  </verify>
  <done>
ColyseusServer wrapper class ready for use.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate HubRoom and schemas</name>
  <files>
    GameBuddieGamesServer/games/hub/HubRoom.ts,
    GameBuddieGamesServer/games/hub/schema/HubState.ts,
    GameBuddieGamesServer/games/hub/schema/Player.ts,
    GameBuddieGamesServer/games/hub/index.ts
  </files>
  <action>
Copy and adapt HubRoom from GameBuddiesHub/server:

1. Create games/hub/ directory structure
2. Copy HubState schema (players MapSchema, messages)
3. Copy Player schema (x, y, anim, name)
4. Copy HubRoom with message handlers:
   - Message.UPDATE_PLAYER (0) - position/animation updates
   - Message.UPDATE_PLAYER_NAME (1) - set player name
5. Adapt imports for new location
6. Export from index.ts

Keep it simple - just player positions and basic state for now.
  </action>
  <verify>
Files compile without TypeScript errors.
HubRoom can be imported from games/hub.
  </verify>
  <done>
HubRoom and schemas migrated to GameBuddieGamesServer/games/hub/.
  </done>
</task>

<task type="auto">
  <name>Task 4: Initialize Colyseus in main server</name>
  <files>
    GameBuddieGamesServer/core/server.ts
  </files>
  <action>
Modify UnifiedGameServer to:

1. Import ColyseusServer and HubRoom
2. Add colyseusServer property
3. In start() method:
   - Create ColyseusServer instance with same CORS origins
   - Define 'hub' room with HubRoom class
   - Call colyseusServer.listen(COLYSEUS_PORT) where COLYSEUS_PORT = 3002
4. In shutdown() method:
   - Call colyseusServer.shutdown()
5. Add /colyseus health check route

Log startup message showing both ports:
```
üéÆ Socket.IO server on port 3001
üè† Colyseus server on port 3002 (Hub)
```
  </action>
  <verify>
npm run dev starts both servers.
Console shows both servers listening.
GET /health shows colyseus status.
  </verify>
  <done>
Colyseus integrated into GameBuddieGamesServer startup.
Both servers run on separate ports.
  </done>
</task>

<task type="auto">
  <name>Task 5: Test Colyseus connection</name>
  <files>
    (no new files - testing only)
  </files>
  <action>
Create simple test to verify Colyseus is working:

1. Start GameBuddieGamesServer with npm run dev
2. Verify console shows both servers started
3. Test Colyseus endpoint is accessible:
   - curl http://localhost:3002/health (if health route added)
   - Or use browser to check WebSocket upgrade works
4. Check no errors in console during startup

If RetroArcade has existing Colyseus tests, reference them.
  </action>
  <verify>
Server starts without errors.
Both ports respond.
No WebSocket conflicts.
  </verify>
  <done>
Colyseus server verified working on port 3002.
Ready for client connection.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run dev starts both Socket.IO (3001) and Colyseus (3002)
- [ ] No startup errors
- [ ] HubRoom is defined and accessible
- [ ] Existing Socket.IO games unaffected
</verification>

<success_criteria>
- Colyseus running alongside Socket.IO in same process
- HubRoom available for client connections
- Clean separation - Colyseus on 3002, Socket.IO on 3001
- No breaking changes to existing games
</success_criteria>

<output>
After completion, create `.planning/phases/1.5-integration/1.5-01-SUMMARY.md`
</output>
