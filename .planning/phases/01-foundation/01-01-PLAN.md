---
phase: 01-foundation
plan: 01
type: execute
---

<objective>
Set up GameBuddies Hub project structure with Colyseus server foundation.

Purpose: Create the server-side infrastructure for the virtual hub - Colyseus room with player state sync.
Output: Working Colyseus server that accepts connections and syncs player positions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Reference Implementation:**
@SkyOffice/server/index.ts
@SkyOffice/server/rooms/SkyOffice.ts
@SkyOffice/server/rooms/schema/OfficeState.ts
@SkyOffice/types/IOfficeState.ts
@SkyOffice/types/Messages.ts
@SkyOffice/types/Rooms.ts

**Established patterns:**
- Colyseus 0.14 for multiplayer state sync
- Express for HTTP server
- TypeScript throughout
- Schema-based state with MapSchema for players

**Key decisions:**
- Use Colyseus (not Socket.io) for hub state - better state sync for persistent worlds
- Simplified schema: players only (no computers/whiteboards from SkyOffice)
- Single public hub room for v1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GameBuddiesHub project structure</name>
  <files>
    GameBuddiesHub/package.json,
    GameBuddiesHub/server/package.json,
    GameBuddiesHub/server/tsconfig.json,
    GameBuddiesHub/types/package.json,
    GameBuddiesHub/types/tsconfig.json
  </files>
  <action>
Create new GameBuddiesHub directory with server and types subdirectories.

Root package.json with:
- name: "gamebuddies-hub"
- scripts: start (runs server), dev (runs server with ts-node-dev)
- devDependencies: typescript, ts-node-dev, eslint, @typescript-eslint/*

Server package.json with:
- dependencies: colyseus@^0.14.0, @colyseus/monitor@^0.14.0, express, cors
- devDependencies: @types/express, @types/cors

Types package.json for shared type definitions.

Both tsconfig.json files should target ES2020, use strict mode, and output to dist/.

DO NOT copy SkyOffice wholesale - create a clean minimal structure specific to GameBuddies Hub needs.
  </action>
  <verify>
cd GameBuddiesHub && npm install && cd server && npm install && cd ../types && npm install
All installs succeed without errors
  </verify>
  <done>
GameBuddiesHub/ directory exists with server/, types/ subdirectories.
All package.json files present with correct dependencies.
npm install succeeds in all directories.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Colyseus server with HubRoom</name>
  <files>
    GameBuddiesHub/server/index.ts,
    GameBuddiesHub/server/rooms/HubRoom.ts,
    GameBuddiesHub/server/rooms/schema/HubState.ts,
    GameBuddiesHub/types/IHubState.ts,
    GameBuddiesHub/types/Messages.ts,
    GameBuddiesHub/types/Rooms.ts
  </files>
  <action>
Create Colyseus server entry point (server/index.ts):
- Express app with CORS
- Colyseus Server on port 2567 (env PORT)
- Register HubRoom for public hub
- Include @colyseus/monitor at /colyseus route

Create HubRoom (server/rooms/HubRoom.ts):
- Extends Room<HubState>
- onCreate: Initialize state, set up message handlers
- onJoin: Add player to state.players MapSchema
- onLeave: Remove player from state.players
- Message handlers for: UPDATE_PLAYER (x, y, anim), UPDATE_PLAYER_NAME

Create HubState schema (server/rooms/schema/HubState.ts):
- Player schema: x (number), y (number), anim (string), name (string)
- HubState: players (MapSchema<Player>), chatMessages (ArraySchema)
- Use @type decorators from @colyseus/schema

Create shared types (types/):
- IHubState.ts: IPlayer interface, IHubState interface
- Messages.ts: Message enum (UPDATE_PLAYER, UPDATE_PLAYER_NAME, ADD_CHAT_MESSAGE, SEND_ROOM_DATA)
- Rooms.ts: RoomType enum (HUB)

Keep schema minimal - only what's needed for player sync.
DO NOT include computer/whiteboard logic from SkyOffice.
  </action>
  <verify>
cd GameBuddiesHub && npm run dev
Server starts and logs "Listening on ws://localhost:2567"
Visit http://localhost:2567/colyseus - monitor page loads
  </verify>
  <done>
Colyseus server starts on port 2567.
HubRoom defined and registered.
Monitor accessible at /colyseus.
TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add player movement message handling</name>
  <files>
    GameBuddiesHub/server/rooms/HubRoom.ts,
    GameBuddiesHub/server/rooms/commands/PlayerUpdateCommand.ts
  </files>
  <action>
Implement player update command pattern (from SkyOffice):

Create PlayerUpdateCommand (server/rooms/commands/PlayerUpdateCommand.ts):
- Use @colyseus/command Dispatcher pattern
- Command updates player x, y, anim in state
- Validate message payload before updating

Update HubRoom to:
- Create Dispatcher in onCreate
- Register onMessage handler for UPDATE_PLAYER
- Dispatch PlayerUpdateCommand with client + payload
- Add onMessage for UPDATE_PLAYER_NAME (updates player.name)

The Colyseus schema automatically syncs state changes to all clients.
No need to broadcast manually - state sync handles it.
  </action>
  <verify>
npm run dev starts without TypeScript errors.
Server logs show no warnings.
  </verify>
  <done>
Player position updates handled via command pattern.
State changes will auto-sync to connected clients.
Clean separation between message handling and state mutation.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd GameBuddiesHub && npm run dev` starts server
- [ ] Server logs "Listening on ws://localhost:2567"
- [ ] http://localhost:2567/colyseus shows Colyseus monitor
- [ ] TypeScript compiles without errors
- [ ] No runtime errors on startup
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Colyseus server accepting connections
- HubRoom registered and functional
- Schema-based state ready for client connection
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
